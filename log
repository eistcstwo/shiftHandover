// loginApi.js
import api from './api'; // Assuming you have an api instance configured

export const postLogin = async (uid, password) => {
  try {
    const response = await api.post('awthenticationService/newLogin/', { "uid": uid, "password": password });
    
    const uidd = response.data.userId;
    const passwordd = response.data.password;
    const username = response.data.username;
    const userlevel = response.data.userLevel;
    const sessionToken = response.data.session_token;
    
    console.log("Login response - username:", username);
    console.log("Login response - userlevel:", userlevel);
    
    // Store credentials in localStorage if valid
    if (uidd && passwordd) {
      localStorage.setItem('uidd', uidd);
      localStorage.setItem('password', passwordd);
      localStorage.setItem('username', username);
      localStorage.setItem('userlevel', userlevel);
      localStorage.setItem('sessionid', sessionToken);
      console.log('Stored uidd in localStorage:', localStorage.getItem('uidd'));
    }
    
    return response;
  } catch (error) {
    console.error('Login error:', error);
    throw error; // Re-throw to allow component-level handling
  }
};

export async function authenticatePortal() {
  try {
    const sessionId = localStorage.getItem('sessionid');
    const uid = localStorage.getItem('uidd');
    
    if (!sessionId || !uid) {
      console.log('authenticatePortal: No session credentials found');
      return {
        success: false,
        status: 0,
        message: 'No session credentials',
        data: null
      };
    }
    
    // Use the api instance for consistency
    const response = await api.post('awthenticationService/authenticatePortal/', 
      { uid },
      {
        headers: {
          'Authorization': `Bearer ${sessionId}`
        }
      }
    );
    
    const data = response.data;
    
    console.log('authenticatePortal response:', {
      status: response.status,
      data
    });
    
    // Check if authentication was successful
    const isSuccess = response.status === 302 || 
                      response.status === 200 || 
                      data.Response === "login successfull";
    
    return {
      success: isSuccess,
      status: response.status,
      message: data.Response || data.message,
      data: data
    };
  } catch (error) {
    console.error('Error authenticating portal:', error);
    return {
      success: false,
      status: error.response?.status || 0,
      message: error.message,
      data: null
    };
  }
}
