// loginApi.js
import api from './api'; // Assuming you have an api instance configured

export const postLogin = async (uid, password) => {
  try {
    const response = await api.post('awthenticationService/newLogin/', { "uid": uid, "password": password });
    
    const uidd = response.data.userId;
    const passwordd = response.data.password;
    const username = response.data.username;
    const userlevel = response.data.userLevel;
    const sessionToken = response.data.session_token;
    
    console.log("Login response - username:", username);
    console.log("Login response - userlevel:", userlevel);
    
    // Store credentials in localStorage if valid
    if (uidd && passwordd) {
      localStorage.setItem('uidd', uidd);
      localStorage.setItem('password', passwordd);
      localStorage.setItem('username', username);
      localStorage.setItem('userlevel', userlevel);
      localStorage.setItem('sessionid', sessionToken);
      console.log('Stored uidd in localStorage:', localStorage.getItem('uidd'));
    }
    
    return response;
  } catch (error) {
    console.error('Login error:', error);
    throw error; // Re-throw to allow component-level handling
  }
};

export async function authenticatePortal() {
  try {
    const sessionId = localStorage.getItem('sessionid');
    const uid = localStorage.getItem('uidd');
    
    if (!sessionId || !uid) {
      console.log('authenticatePortal: No session credentials found');
      return {
        success: false,
        status: 0,
        message: 'No session credentials',
        data: null
      };
    }
    
    const response = await fetch(
      'https://10.191.171.12:5443/EISHOME/awthenticationService/authenticatePortal/',
      {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionId}`
        },
        credentials: 'include',
        body: JSON.stringify({ uid })
      }
    );
    
    const data = await response.json();
    
    console.log('authenticatePortal response:', {
      status: response.status,
      data
    });
    
    return {
      success: response.status === 302 || response.status === 200,
      status: response.status,
      message: data.Response || data.message,
      data: data
    };
  } catch (error) {
    console.error('Error authenticating portal:', error);
    return {
      success: false,
      status: 0,
      message: error.message,
      data: null
    };
  }
}
