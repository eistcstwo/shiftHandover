// loginApi.js

export async function postLogin(username, password) {
  try {
    const response = await fetch(
      'https://10.191.171.12:5443/EISHOME/awthenticationService/newLogin/',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      }
    );
    const data = await response.json();
    
    // Store session data in localStorage if login is successful
    if (data.status === 302 || data.status === 200) {
      if (data.sessionid) localStorage.setItem('sessionid', data.sessionid);
      if (data.uid) localStorage.setItem('uidd', data.uid);
      if (data.userLevel) localStorage.setItem('userlevel', data.userLevel);
      if (data.username || username) localStorage.setItem('username', data.username || username);
    }
    
    return { data };
  } catch (error) {
    console.error('Error in postLogin:', error);
    throw error;
  }
}

export async function authenticatePortal() {
  try {
    const sessionId = localStorage.getItem('sessionid');
    const uid = localStorage.getItem('uidd');
    
    if (!sessionId || !uid) {
      console.log('authenticatePortal: No session credentials found');
      return {
        success: false,
        status: 0,
        message: 'No session credentials',
        data: null
      };
    }
    
    const response = await fetch(
      'https://10.191.171.12:5443/EISHOME/awthenticationService/authenticatePortal/',
      {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionId}`
        },
        credentials: 'include',
        body: JSON.stringify({ uid })
      }
    );
    
    const data = await response.json();
    
    console.log('authenticatePortal response:', {
      status: response.status,
      data
    });
    
    return {
      success: response.status === 302 || response.status === 200,
      status: response.status,
      message: data.Response || data.message,
      data: data
    };
  } catch (error) {
    console.error('Error authenticating portal:', error);
    return {
      success: false,
      status: 0,
      message: error.message,
      data: null
    };
  }
}
