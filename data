// FDCAlert.js

// Function to fetch JSON and render the FDC alert widget
async function fetchAndRenderFDCAlerts() {
    const jsonUrl = 'FINAL_FDC_error.json';
    try {
        const response = await fetch(jsonUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const rawData = await response.text();
        let data;
        try {
            data = JSON.parse(rawData);
        } catch (e) {
            console.error('Could not parse FDC JSON. Ensure the file contains valid JSON.', e);
            return;
        }
        renderFDCAlertWidget(data);
    } catch (error) {
        console.error('Error fetching FDC JSON data:', error);
    }
}

// Function to render the fixed alert box and the alert table
function renderFDCAlertWidget(jsonData) {
    const container = document.getElementById('fdc-alert-widget-container');
    if (!container) return;

    const allAlerts = [];

    for (const ipAddress in jsonData) {
        const errorData = jsonData[ipAddress];
        if (errorData.FIRST_occurance !== "" || errorData.Last_occurance !== "") {
            allAlerts.push({
                id: `${ipAddress}-${Date.now()}`,
                ip: ipAddress,
                firstOccurance: errorData.FIRST_occurance,
                lastOccurance: errorData.Last_occurance,
                env: ipAddress.startsWith('10.188.24') ? '10.188.24.x' : 
                     (ipAddress.startsWith('10.188.25') ? '10.188.25.x' : 'Other')
            });
        }
    }

    const alertCount = allAlerts.length;

    // Only show alert widget if there are errors
    if (alertCount === 0) {
        return; // Exit early, don't create any UI elements
    }

    // --- Alert Box (Widget) Creation ---
    const alertBox = document.createElement('div');
    alertBox.id = 'fdc-alert-box';
    alertBox.innerHTML = `
        <span class="icon">⚠️</span>
        <span class="count">${alertCount}</span>
        <div class="message">FDC Errors</div>
    `;
    alertBox.className = "blink";
    container.appendChild(alertBox);

    // --- Modal (Backdrop and Table) Creation ---
    const backdrop = document.createElement('div');
    backdrop.className = 'fdc-backdrop';
    backdrop.style.display = 'none';
    document.body.appendChild(backdrop);

    const alertTable = document.createElement('div');
    alertTable.id = 'fdc-alert-table';
    alertTable.style.display = 'none';
    container.appendChild(alertTable);

    function closeAlertTable() {
        alertTable.style.display = 'none';
        backdrop.style.display = 'none';
    }

    // Helper function to generate table rows with IP grouping using rowspan
    function generateTableRows(filterEnv = null) {
        const filteredAlerts = filterEnv
            ? allAlerts.filter(alert => alert.env === filterEnv)
            : allAlerts;

        // Sort alerts by IP
        filteredAlerts.sort((a, b) => {
            const numA = Number(a.ip.split('.').map(num => num.padStart(3, '0')).join(''));
            const numB = Number(b.ip.split('.').map(num => num.padStart(3, '0')).join(''));
            return numA - numB;
        });

        let tableHtml = '';
        let ipGroups = {}; // Count occurrences of each IP

        // Count group sizes
        filteredAlerts.forEach(alert => {
            ipGroups[alert.ip] = (ipGroups[alert.ip] || 0) + 1;
        });

        let previousIp = '';

        filteredAlerts.forEach(alert => {
            tableHtml += `<tr class="alert-row error" data-alert-id="${alert.id}">`;

            // Add IP Cell with Rowspan (only for the first item in the group)
            if (alert.ip !== previousIp) {
                const rowSpanCount = ipGroups[alert.ip];
                tableHtml += `
                    <td rowspan="${rowSpanCount}" class="ip-group-cell">
                        <strong>${alert.ip}</strong>
                    </td>
                `;
                previousIp = alert.ip;
            }

            // Add the rest of the cells
            tableHtml += `
                <td>${alert.firstOccurance}</td>
                <td>${alert.lastOccurance}</td>
            </tr>
            `;
        });

        return tableHtml;
    }

    // Function to render the full table structure (combined, no tabs)
    function renderTableContent() {
        alertTable.innerHTML = `
            <h3>FDC Error Alerts (${alertCount})</h3>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>First Occurrence</th>
                            <th>Last Occurrence</th>
                        </tr>
                    </thead>
                    <tbody id="fdc-alert-table-body">
                        ${generateTableRows(null)}
                    </tbody>
                </table>
            </div>
            <button id="close-table-btn" class="modal-action-btn">Close</button>
        `;
    }

    // --- EVENT DELEGATION ---
    alertTable.addEventListener('click', function(event) {
        if (event.target.id === 'close-table-btn') {
            closeAlertTable();
        }
    });

    // --- Initial Setup ---
    renderTableContent();

    container.appendChild(alertTable);

    alertBox.addEventListener('click', () => {
        alertTable.style.display = 'block';
        backdrop.style.display = 'block';
    });

    backdrop.addEventListener('click', closeAlertTable);
}

// Call the main function to start everything when the script loads
fetchAndRenderFDCAlerts();
