// FDC Alert Widget - Fixed Rendering
(function() {
    'use strict';
    
    // Prevent multiple initializations
    if (window.FDCAlertInitialized) {
        console.log('FDC Alert already initialized');
        return;
    }
    window.FDCAlertInitialized = true;
    
    // Main function to fetch JSON and render the alert widget
    async function fetchAndRenderFDCAlerts() {
        const jsonUrl = 'FINAL_FDC_error.json';
        try {
            const response = await fetch(jsonUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const rawData = await response.text();
            let data;
            try {
                data = JSON.parse(rawData);
            } catch (e) {
                console.error('Could not parse JSON. Ensure the file contains valid JSON.', e);
                return;
            }
            renderFDCAlertWidget(data);
        } catch (error) {
            console.error('Error fetching JSON data:', error);
        }
    }

    // Function to render the fixed alert box and the alert table
    function renderFDCAlertWidget(jsonData) {
        const container = document.getElementById('fdc-alert-widget-container');
        if (!container) {
            console.error('Container #fdc-alert-widget-container not found!');
            return;
        }

        const allAlerts = [];

        // Process JSON data
        for (const ipAddress in jsonData) {
            const errorData = jsonData[ipAddress];
            if (errorData.FIRST_occurance !== "" || errorData.Last_occurance !== "") {
                allAlerts.push({
                    id: `${ipAddress}-${Date.now()}`,
                    ip: ipAddress,
                    firstOccurance: errorData.FIRST_occurance,
                    lastOccurance: errorData.Last_occurance,
                    env: ipAddress.startsWith('10.188.24') ? '10.188.24.x' : 
                         (ipAddress.startsWith('10.188.25') ? '10.188.25.x' : 'Other')
                });
            }
        }

        const alertCount = allAlerts.length;

        // Only show alert widget if there are errors
        if (alertCount === 0) {
            return; // Exit early, don't create any UI elements
        }

        // Remove existing elements if they exist (for refresh)
        const existingBox = document.getElementById('fdc-alert-box');
        const existingTable = document.getElementById('fdc-alert-table');
        const existingBackdrop = document.querySelector('.fdc-backdrop');
        
        if (existingBox) existingBox.remove();
        if (existingTable) existingTable.remove();
        if (existingBackdrop) existingBackdrop.remove();

        // --- Alert Box (Widget) Creation ---
        const alertBox = document.createElement('div');
        alertBox.id = 'fdc-alert-box';
        alertBox.innerHTML = `
            <span class="fdc-icon">⚠️</span>
            <span class="fdc-count">${alertCount}</span>
            <div class="fdc-message">FDC Errors</div>
        `;
        alertBox.className = "fdc-blink";
        container.appendChild(alertBox);

        // --- Modal (Backdrop and Table) Creation ---
        const backdrop = document.createElement('div');
        backdrop.className = 'fdc-backdrop';
        backdrop.style.display = 'none';
        document.body.appendChild(backdrop);

        const alertTable = document.createElement('div');
        alertTable.id = 'fdc-alert-table';
        alertTable.style.display = 'none';
        document.body.appendChild(alertTable);

        function closeAlertTable() {
            alertTable.style.display = 'none';
            backdrop.style.display = 'none';
            console.log('Table closed');
        }

        function openAlertTable() {
            console.log('Opening table...');
            alertTable.style.display = 'block';
            backdrop.style.display = 'block';
            console.log('Table display:', alertTable.style.display);
            console.log('Backdrop display:', backdrop.style.display);
        }

        // Helper function to generate table rows with IP grouping using rowspan
        function generateTableRows(filterEnv = null) {
            const filteredAlerts = filterEnv
                ? allAlerts.filter(alert => alert.env === filterEnv)
                : allAlerts;

            // Sort alerts by IP
            filteredAlerts.sort((a, b) => {
                const numA = Number(a.ip.split('.').map(num => num.padStart(3, '0')).join(''));
                const numB = Number(b.ip.split('.').map(num => num.padStart(3, '0')).join(''));
                return numA - numB;
            });

            let tableHtml = '';
            let ipGroups = {}; // Count occurrences of each IP

            // Count group sizes
            filteredAlerts.forEach(alert => {
                ipGroups[alert.ip] = (ipGroups[alert.ip] || 0) + 1;
            });

            let previousIp = '';

            filteredAlerts.forEach(alert => {
                tableHtml += `<tr class="fdc-alert-row fdc-error" data-alert-id="${alert.id}">`;

                // Add IP Cell with Rowspan (only for the first item in the group)
                if (alert.ip !== previousIp) {
                    const rowSpanCount = ipGroups[alert.ip];
                    tableHtml += `
                        <td rowspan="${rowSpanCount}" class="fdc-ip-group-cell">
                            <strong>${alert.ip}</strong>
                        </td>
                    `;
                    previousIp = alert.ip;
                }

                // Add the rest of the cells
                tableHtml += `
                    <td>${alert.firstOccurance}</td>
                    <td>${alert.lastOccurance}</td>
                </tr>
                `;
            });

            return tableHtml;
        }

        // Function to render the full table structure
        function renderTableContent() {
            alertTable.innerHTML = `
                <h3>FDC Error Alerts (${alertCount})</h3>

                <div class="fdc-table-container">
                    <table class="fdc-alerts-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>First Occurrence</th>
                                <th>Last Occurrence</th>
                            </tr>
                        </thead>
                        <tbody id="fdc-alert-table-body">
                            ${generateTableRows(null)}
                        </tbody>
                    </table>
                </div>
                <button id="fdc-close-table-btn" class="fdc-close-btn">Close</button>
            `;
            
            console.log('Table content rendered');
        }

        // --- Initial Setup ---
        renderTableContent();

        // --- EVENT LISTENERS ---
        alertBox.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openAlertTable();
        });

        backdrop.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeAlertTable();
        });

        // Event delegation for close button
        alertTable.addEventListener('click', function(event) {
            if (event.target.id === 'fdc-close-table-btn') {
                event.preventDefault();
                event.stopPropagation();
                closeAlertTable();
            }
        });
        
        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAlertTable();
            }
        });

        console.log('FDC Alert Widget initialized with', alertCount, 'alerts');
    }

    // Initialize when DOM is ready
    function initializeFDCWidget() {
        console.log('Initializing FDC Widget...');
        fetchAndRenderFDCAlerts();
        
        // Optional: Auto-refresh every 60 seconds
        setInterval(fetchAndRenderFDCAlerts, 60000);
    }

    // Start when DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeFDCWidget);
    } else {
        // DOM already loaded
        initializeFDCWidget();
    }

    // Make functions available globally for debugging
    window.FDCAlert = {
        refresh: fetchAndRenderFDCAlerts,
        render: renderFDCAlertWidget
    };
})();
