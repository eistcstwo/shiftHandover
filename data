// FDC Alert Widget - Isolated JavaScript
// Add this to your existing HTML page

(function() {
    'use strict';
    
    // Prevent multiple initializations
    if (window.FDCAlertInitialized) {
        return;
    }
    window.FDCAlertInitialized = true;
    
    // Configuration
    const CONFIG = {
        jsonUrl: 'FINAL_FDC_error.json',
        pollInterval: 60000, // Check every 60 seconds
        widgetPosition: {
            top: '11px',
            right: '344px'
        }
    };
    
    // State management
    let widgetState = {
        alerts: [],
        isModalOpen: false,
        backdrop: null,
        alertTable: null
    };
    
    // Main initialization
    function initFDCAlertWidget() {
        console.log('Initializing FDC Alert Widget...');
        
        // Create or get container
        let container = document.getElementById('fdc-alert-widget-container');
        if (!container) {
            console.error('FDC Alert Container not found!');
            return;
        }
        
        // Ensure container is empty
        container.innerHTML = '';
        
        // Load data
        loadFDCData();
        
        // Set up polling
        setInterval(loadFDCData, CONFIG.pollInterval);
    }
    
    // Load JSON data
    async function loadFDCData() {
        try {
            const response = await fetch(CONFIG.jsonUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const jsonData = await response.json();
            processFDCData(jsonData);
        } catch (error) {
            console.error('Error loading FDC data:', error);
            // You could show a fallback or error state here
        }
    }
    
    // Process the JSON data
    function processFDCData(jsonData) {
        const allAlerts = [];
        
        for (const ipAddress in jsonData) {
            const errorData = jsonData[ipAddress];
            if (errorData.FIRST_occurance || errorData.Last_occurance) {
                allAlerts.push({
                    id: `${ipAddress}-${Date.now()}`,
                    ip: ipAddress,
                    firstOccurance: errorData.FIRST_occurance || 'N/A',
                    lastOccurance: errorData.Last_occurance || 'N/A',
                    env: ipAddress.startsWith('10.188.24') ? '10.188.24.x' : 
                         (ipAddress.startsWith('10.188.25') ? '10.188.25.x' : 'Other')
                });
            }
        }
        
        widgetState.alerts = allAlerts;
        renderFDCWidget(allAlerts);
    }
    
    // Render the widget
    function renderFDCWidget(alerts) {
        const container = document.getElementById('fdc-alert-widget-container');
        if (!container) return;
        
        const alertCount = alerts.length;
        
        // Clear existing widget
        const existingAlertBox = document.getElementById('fdc-alert-box');
        if (existingAlertBox) {
            existingAlertBox.remove();
        }
        
        // Don't show widget if no alerts
        if (alertCount === 0) {
            return;
        }
        
        // Create alert box
        const alertBox = document.createElement('div');
        alertBox.id = 'fdc-alert-box';
        alertBox.className = 'fdc-blink';
        alertBox.innerHTML = `
            <span class="fdc-icon">⚠️</span>
            <span class="fdc-count">${alertCount}</span>
            <div class="fdc-message">FDC Errors</div>
        `;
        
        container.appendChild(alertBox);
        
        // Add click handler
        alertBox.addEventListener('click', openFDCModal);
        
        // Create modal elements if they don't exist
        createFDCModal();
    }
    
    // Create modal elements
    function createFDCModal() {
        // Create backdrop if it doesn't exist
        if (!widgetState.backdrop) {
            widgetState.backdrop = document.createElement('div');
            widgetState.backdrop.className = 'fdc-backdrop';
            document.body.appendChild(widgetState.backdrop);
            
            // Close modal when clicking backdrop
            widgetState.backdrop.addEventListener('click', closeFDCModal);
        }
        
        // Create alert table if it doesn't exist
        if (!widgetState.alertTable) {
            widgetState.alertTable = document.createElement('div');
            widgetState.alertTable.id = 'fdc-alert-table';
            document.body.appendChild(widgetState.alertTable);
        }
    }
    
    // Open modal
    function openFDCModal() {
        if (!widgetState.alertTable) return;
        
        // Update modal content
        updateFDCModalContent();
        
        // Show modal
        widgetState.alertTable.style.display = 'block';
        widgetState.backdrop.style.display = 'block';
        widgetState.isModalOpen = true;
        
        // Prevent body scrolling
        document.body.style.overflow = 'hidden';
    }
    
    // Close modal
    function closeFDCModal() {
        if (!widgetState.alertTable) return;
        
        widgetState.alertTable.style.display = 'none';
        widgetState.backdrop.style.display = 'none';
        widgetState.isModalOpen = false;
        
        // Restore body scrolling
        document.body.style.overflow = '';
    }
    
    // Update modal content
    function updateFDCModalContent() {
        if (!widgetState.alertTable) return;
        
        const alertCount = widgetState.alerts.length;
        
        // Sort alerts by IP
        const sortedAlerts = [...widgetState.alerts].sort((a, b) => {
            const ipToNum = (ip) => {
                const parts = ip.split('.').map(Number);
                return (parts[0] << 24) + (parts[1] << 16) + (parts[2] << 8) + parts[3];
            };
            return ipToNum(a.ip) - ipToNum(b.ip);
        });
        
        // Generate table HTML
        let tableHTML = '';
        let ipGroups = {};
        
        // Count occurrences of each IP
        sortedAlerts.forEach(alert => {
            ipGroups[alert.ip] = (ipGroups[alert.ip] || 0) + 1;
        });
        
        let previousIp = '';
        
        sortedAlerts.forEach(alert => {
            tableHTML += `<tr class="fdc-alert-row fdc-error">`;
            
            // Add IP cell with rowspan for first occurrence
            if (alert.ip !== previousIp) {
                const rowSpanCount = ipGroups[alert.ip];
                tableHTML += `
                    <td rowspan="${rowSpanCount}" class="fdc-ip-group-cell">
                        <strong>${alert.ip}</strong>
                    </td>
                `;
                previousIp = alert.ip;
            }
            
            // Add data cells
            tableHTML += `
                <td>${alert.firstOccurance}</td>
                <td>${alert.lastOccurance}</td>
            </tr>`;
        });
        
        // Update modal HTML
        widgetState.alertTable.innerHTML = `
            <h3>FDC Error Alerts (${alertCount})</h3>
            <div class="fdc-table-container">
                <table class="fdc-alerts-table">
                    <thead>
                        <tr>
                            <th width="25%">IP Address</th>
                            <th width="37.5%">First Occurrence</th>
                            <th width="37.5%">Last Occurrence</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableHTML}
                    </tbody>
                </table>
            </div>
            <button class="fdc-close-btn">Close</button>
        `;
        
        // Add close button event listener
        const closeBtn = widgetState.alertTable.querySelector('.fdc-close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeFDCModal);
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function escapeHandler(e) {
            if (e.key === 'Escape' && widgetState.isModalOpen) {
                closeFDCModal();
                document.removeEventListener('keydown', escapeHandler);
            }
        });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFDCAlertWidget);
    } else {
        initFDCAlertWidget();
    }
    
    // Make functions available globally if needed
    window.FDCAlert = {
        refresh: loadFDCData,
        openModal: openFDCModal,
        closeModal: closeFDCModal
    };
    
})();
